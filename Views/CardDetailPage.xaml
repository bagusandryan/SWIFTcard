<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:contentviews="clr-namespace:SWIFTcard.ContentViews"
             xmlns:viewmodels="clr-namespace:SWIFTcard.ViewModels"
             xmlns:models="clr-namespace:SWIFTcard.Models"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="SWIFTcard.Views.CardDetailPage"
             Title="CardDetailPage"
             x:Name="This"
             BackgroundColor="Transparent">
    <ContentPage.Resources>
        <toolkit:InvertedBoolConverter x:Key="InvertedBoolConverter" />
    </ContentPage.Resources>
    <Frame Margin="-2,0,-2,-30"
           CornerRadius="30"
           >
        <Frame.Triggers>
            <DataTrigger TargetType="Frame"
                         Binding="{Binding IsEnabled, Source={x:Reference FakeGrid}}"
                         Value="True">
                <Setter Property="VerticalOptions"
                        Value="End" />
            </DataTrigger>
            <DataTrigger TargetType="Frame"
                         Binding="{Binding IsEnabled, Source={x:Reference FakeGrid}}"
                         Value="False">
                <Setter Property="VerticalOptions"
                        Value="StartAndExpand" />
            </DataTrigger>
        </Frame.Triggers>
        <Frame.GestureRecognizers>
            <SwipeGestureRecognizer Direction="Down" Swiped="OnSwipedDown"/>
        </Frame.GestureRecognizers>
        <Grid x:DataType="viewmodels:CardDetailViewModel">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            <Grid x:Name="FakeGrid" WidthRequest="0" HeightRequest="0" IsEnabled="{Binding _viewModel.IsAddMode, Source={x:Reference This}}"/>
            <VerticalStackLayout Padding="20"
                                 x:Name="AddNewCardStackLayout"
                                 IsVisible="{Binding IsAddMode}"
                                 Grid.Row="0"
                                 >
                <contentviews:InputCard CardHeight="168"
                                        Margin="-18,0,-18,0"
                                        Header="New Word"
                                        x:Name="Question"/>
                <contentviews:InputCard CardHeight="168"
                                        Margin="-18,-60,-18,0"
                                        Header="Translation"
                                        x:Name="Answer"/>
                <contentviews:InputCard CardHeight="200"
                                        Margin="-18,-60,-18,0"
                                        Header="Context"
                                        IsMultipleLines="True"
                                        x:Name="Context"/>
                <Button
                    Margin="0,-60,0,8"
                    ImageSource="save.png"
                    HorizontalOptions="End"
                    Style="{DynamicResource PrimaryCircleButton}"
                    Clicked="AddNewCard"/>
            </VerticalStackLayout>
            <Label Text="Your cards"
                   Margin="0,0,0,8"
                   Grid.Row="1"
                   Style="{DynamicResource CardFooterLabel}"/>
            <CollectionView x:Name="AllCardsCollectionView"
                            ItemsSource="{Binding CardList}"
                            Rotation="180"
                            Grid.Row="2"
                            ItemsUpdatingScrollMode="KeepLastItemInView"
                            ChildAdded="AllCardsCollectionView_ChildAdded"
                            >
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical"
                                       SnapPointsType="None"
                                       SnapPointsAlignment="End" />
                </CollectionView.ItemsLayout>
                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <SwipeView Rotation="180">
                            <SwipeView.RightItems>
                                <SwipeItems Mode="Execute">
                                    <SwipeItemView  Command="{Binding BindingContext.DeleteCardCommand, Source={x:Reference This}}"
                                                    CommandParameter="{Binding Source={RelativeSource Self}, Path=BindingContext}"
                                                    >
                                        <Grid Margin="20,0"
                                              Padding="20,0">
                                            <Image Source="delete.png"/>
                                        </Grid>
                                    </SwipeItemView>
                                </SwipeItems>
                            </SwipeView.RightItems>
                            <Frame  BackgroundColor="{DynamicResource CardBackgroundColor}"
                                    BorderColor="Transparent"
                                    CornerRadius="30"
                                    Padding="30"
                                    VerticalOptions="Start"
                                    Margin="0,0,0,10">
                                    <VerticalStackLayout x:DataType="models:Card">
                                        <HorizontalStackLayout>
                                            <Label Text="{Binding Question}"
                                                   Style="{DynamicResource MiniCardHeaderLabel}"/>
                                            <Label Text=" | "
                                                   Style="{DynamicResource CardFooterLabel}"
                                                   Opacity="{DynamicResource SemiTransparentOpacity}"/>
                                            <Label Text="{Binding Answer}"
                                                   Style="{DynamicResource CardFooterLabel}"
                                                   Opacity="{DynamicResource SemiTransparentOpacity}"/>
                                        </HorizontalStackLayout>
                                        <Label Text="{Binding Context}"
                                               LineBreakMode="WordWrap"
                                               Style="{DynamicResource MiniCardBodyLabel}"/>
                                    </VerticalStackLayout>
                            </Frame>
                        </SwipeView>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </Grid>
    </Frame>
</ContentPage>
